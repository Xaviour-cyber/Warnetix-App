<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Simple Upload • Warnetix</title>
    <style>
      body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0b0b0b;color:#e5e5e5;margin:0;padding:24px}
      .wrap{max-width:860px;margin:0 auto;display:grid;gap:16px}
      .card{background:#0f0f0f;border:1px solid #222;border-radius:12px;padding:18px}
      .row{display:flex;gap:10px;align-items:center}
      .btn{background:#e50914;border:0;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
      .btn:disabled{opacity:.6;cursor:not-allowed}
      .dz{border:2px dashed #2b2b2b;border-radius:12px;padding:28px;text-align:center}
      .dz.drag{border-color:#e50914;background:#141414}
      pre{white-space:pre-wrap;background:#0e0e0e;border:1px solid #222;border-radius:8px;padding:12px;max-height:360px;overflow:auto}
      small{color:#9ca3af}
    </style>
  </head>
  <body>
    <div class="wrap">
      <h2>Simple Upload (standalone)</h2>
      <div class="card">
        <div class="row">
          <input id="file" type="file" />
          <button id="btn" class="btn">Upload</button>
          <small id="hint"></small>
        </div>
        <div id="dz" class="dz" style="margin-top:12px">Drag & Drop file ke sini</div>
        <progress id="pg" value="0" max="100" style="width:100%;margin-top:12px;display:none"></progress>
      </div>

      <div class="card">
        <h3>Result</h3>
        <pre id="out">-</pre>
      </div>
    </div>

    <script type="module">
      const API_BASE = (import.meta.env.VITE_API_BASE || import.meta.env.VITE_API_BASE_URL || "").replace(/\/+$/,"");
      const fileInput = document.getElementById("file");
      const btn = document.getElementById("btn");
      const out = document.getElementById("out");
      const dz = document.getElementById("dz");
      const pg = document.getElementById("pg");
      const hint = document.getElementById("hint");
      hint.textContent = API_BASE ? "API: " + API_BASE : "API: (empty) set VITE_API_BASE";

      function log(x){ out.textContent = typeof x === "string" ? x : JSON.stringify(x,null,2); }
      function getFile(){ return fileInput.files?.[0] || null; }

      async function upload(file){
        const paths = ["/scan-file","/api/scan","/scan","/api/scan-file"];
        const fd = new FormData(); fd.append("file", file);
        for (const p of paths){
          try{
            const res = await fetch(API_BASE + p, { method:"POST", body: fd });
            const ct = res.headers.get("content-type")||"";
            const data = ct.includes("application/json") ? await res.json() : await res.text();
            if (!res.ok) throw new Error(typeof data === "string" ? data : (data?.error||res.statusText));
            return data;
          }catch(e){ /* coba path berikutnya */ }
        }
        throw new Error("No working upload endpoint");
      }

      async function doUpload(file){
        if (!file) return log("No file chosen.");
        btn.disabled = true; pg.style.display = "block"; pg.value = 5;
        try {
          const t0 = performance.now();
          const data = await upload(file);
          pg.value = 100;
          const dt = ((performance.now()-t0)/1000).toFixed(2);
          log({ ok:true, took_s: Number(dt), data });
        } catch(e){
          log({ ok:false, error: String(e.message || e) });
        } finally {
          setTimeout(()=> pg.style.display = "none", 400);
          btn.disabled = false;
        }
      }

      btn.addEventListener("click", ()=> doUpload(getFile()));
      dz.addEventListener("dragenter", e=>{e.preventDefault(); dz.classList.add("drag");});
      dz.addEventListener("dragover", e=>{e.preventDefault(); dz.classList.add("drag");});
      dz.addEventListener("dragleave", e=>{e.preventDefault(); dz.classList.remove("drag");});
      dz.addEventListener("drop", async e=>{
        e.preventDefault(); dz.classList.remove("drag");
        const f = e.dataTransfer.files?.[0]; if (!f) return;
        await doUpload(f);
      });
    </script>
  </body>
</html>
