<!doctype html>
<meta charset="utf-8"/>
<title>Warnetix â€” Simple Upload</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
  :root{--bg:#0b0b0b;--panel:#121212;--line:#1f2937;--txt:#e5e7eb;--muted:#9aa4b2;--red:#E50914}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.45 Inter,system-ui,Segoe UI,Arial;display:grid;place-items:center}
  .wrap{width:min(900px,92vw)}
  h3{margin:8px 0 16px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:18px}
  .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
  .input{display:flex;gap:10px;align-items:center}
  .btn{background:var(--red);color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .muted{color:var(--muted)}
  .dz{margin-top:12px;border:2px dashed #374151;border-radius:12px;padding:26px;text-align:center;background:#0d0d0d}
  .dz.drag{border-color:var(--red);background:#151515}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  progress{width:100%;height:10px;border-radius:999px;appearance:none}
  progress::-webkit-progress-bar{background:#111}
  progress::-webkit-progress-value{background:var(--red)}
  pre{background:#0b1220;border:1px solid #1f2937;border-radius:10px;padding:12px;overflow:auto}
</style>
<div class="wrap">
  <div class="card">
    <div class="row">
      <h3>Simple Upload</h3>
      <small class="muted">API Base: <span id="base" class="mono"></span></small>
    </div>

    <div class="input">
      <input type="file" id="file" />
      <button class="btn" id="chooseBtn" onclick="file.click()">Choose file</button>
      <button class="btn" id="uploadBtn">Upload</button>
    </div>

    <div id="dz" class="dz">Drag & drop file ke sini</div>

    <div style="margin-top:12px">
      <progress id="pg" max="100" value="0"></progress>
      <small class="muted" id="meta"></small>
    </div>

    <h4>Hasil</h4>
    <pre id="out">-</pre>
  </div>
</div>
<script>
  const qs = new URLSearchParams(location.search);
  const env = (window.VITE_API_BASE || window.VITE_API_BASE_URL || "").replace(/\/+$/,'');
  const BASE = (qs.get('base') || env).replace(/\/+$/,'');
  document.getElementById('base').textContent = BASE || '(unset)';

  const file = document.getElementById('file');
  const dz = document.getElementById('dz');
  const out = document.getElementById('out');
  const meta = document.getElementById('meta');
  const pg = document.getElementById('pg');

  function prettyBytes(b){ if(!b&&b!==0) return '-'; const u=['B','KB','MB','GB']; let i=0; while(b>=1024&&i<u.length-1){b/=1024;i++} return b.toFixed(1)+' '+u[i]; }

  async function upload(selected){
    if(!selected){ out.textContent = 'Pilih file dulu.'; return; }
    meta.textContent = `${selected.name} (${prettyBytes(selected.size)})`;
    pg.value = 0;

    // XHR biar dapet progress
    const tryPaths = ['/api/scan','/scan-file','/scan','/api/scan-file'];
    let lastErr; for (const p of tryPaths){
      try {
        const url = (BASE||'') + p;
        const fd = new FormData(); fd.append('file', selected);
        const data = await new Promise((resolve,reject)=>{
          const xhr = new XMLHttpRequest();
          xhr.open('POST', url);
          xhr.upload.onprogress = (e)=>{ if(e.lengthComputable) pg.value = Math.round((e.loaded/e.total)*100); };
          xhr.onload = ()=>{ try{ resolve(JSON.parse(xhr.responseText)); }catch{ resolve({ raw:xhr.responseText }); } };
          xhr.onerror = ()=>reject(new Error('Network error'));
          xhr.send(fd);
        });
        out.textContent = JSON.stringify(data, null, 2);
        return;
      } catch(e){ lastErr = e; }
    }
    out.textContent = 'Upload gagal: ' + String(lastErr||'unknown');
  }

  // buttons
  document.getElementById('uploadBtn').onclick = ()=>upload(file.files[0]);

  // drag & drop
  ['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev, e=>{e.preventDefault(); dz.classList.add('drag');}));
  ;['dragleave','drop'].forEach(ev=>dz.addEventListener(ev, e=>{e.preventDefault(); dz.classList.remove('drag');}));
  dz.addEventListener('drop', e=>{
    const f = e.dataTransfer.files?.[0];
    if (f) { file.files = e.dataTransfer.files; upload(f); }
  });
</script>
